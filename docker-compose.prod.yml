version: '3.9'

# Production-specific overrides
# Use with: docker-compose -f docker-compose.yml -f docker-compose.prod.yml up -d

services:
  # ==========================================================================
  # CORTEX - PRODUCTION CONFIGURATION
  # ==========================================================================
  cortex:
    build:
      target: production  # Use production stage from Dockerfile
    restart: always
    environment:
      - ENVIRONMENT=production
      - DEBUG=false
      - LOG_LEVEL=INFO
    command: >
      gunicorn api.main:app
      -w 4
      -k uvicorn.workers.UvicornWorker
      -b 0.0.0.0:8000
      --access-logfile -
      --error-logfile -
      --log-level info
      --timeout 120
      --graceful-timeout 30
    volumes:
      # Don't mount source code in production (use image)
      - cortex_downloads:/tmp/hunter_downloads
      - ./logs:/app/logs:rw
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    deploy:
      resources:
        limits:
          cpus: '0.8'
          memory: 512M
        reservations:
          cpus: '0.2'
          memory: 256M

  # ==========================================================================
  # CELERY WORKER - PRODUCTION
  # ==========================================================================
  celery_worker:
    restart: always
    environment:
      - ENVIRONMENT=production
      - LOG_LEVEL=INFO
    command: >
      celery -A services.queue worker
      --loglevel=info
      --concurrency=2
      --max-tasks-per-child=100
      --time-limit=300
      --soft-time-limit=240
    volumes:
      - cortex_downloads:/tmp/hunter_downloads
      - ./logs:/app/logs:rw
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256M

  # ==========================================================================
  # CELERY BEAT - PRODUCTION
  # ==========================================================================
  celery_beat:
    restart: always
    environment:
      - ENVIRONMENT=production
      - LOG_LEVEL=INFO
    volumes:
      - ./logs:/app/logs:rw

  # ==========================================================================
  # POSTGRESQL - PRODUCTION
  # ==========================================================================
  postgres:
    restart: always
    environment:
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}  # Must be strong in production!
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./backups/postgres:/backups
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
    # Enable connection pooling
    command: >
      postgres
      -c max_connections=100
      -c shared_buffers=256MB
      -c effective_cache_size=512MB
      -c maintenance_work_mem=64MB
      -c checkpoint_completion_target=0.9
      -c wal_buffers=16MB
      -c default_statistics_target=100
      -c random_page_cost=1.1
      -c effective_io_concurrency=200

  # ==========================================================================
  # REDIS - PRODUCTION
  # ==========================================================================
  redis:
    restart: always
    command: >
      redis-server
      --appendonly yes
      --appendfsync everysec
      --maxmemory 256mb
      --maxmemory-policy allkeys-lru
    volumes:
      - redis_data:/data
    deploy:
      resources:
        limits:
          cpus: '0.3'
          memory: 256M

  # ==========================================================================
  # RABBITMQ - PRODUCTION
  # ==========================================================================
  rabbitmq:
    restart: always
    environment:
      - RABBITMQ_DEFAULT_PASS=${RABBITMQ_PASSWORD}  # Strong password!
    volumes:
      - rabbitmq_data:/var/lib/rabbitmq
    deploy:
      resources:
        limits:
          cpus: '0.3'
          memory: 256M

  # ==========================================================================
  # NGINX (Optional - if not using external reverse proxy)
  # ==========================================================================
  # nginx:
  #   image: nginx:alpine
  #   container_name: cortex_nginx
  #   restart: always
  #   ports:
  #     - "80:80"
  #     - "443:443"
  #   volumes:
  #     - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
  #     - ./nginx/ssl:/etc/nginx/ssl:ro
  #     - ./logs/nginx:/var/log/nginx
  #   depends_on:
  #     - cortex
  #   deploy:
  #     resources:
  #       limits:
  #         cpus: '0.2'
  #         memory: 128M

volumes:
  postgres_data:
    driver: local
  redis_data:
    driver: local
  rabbitmq_data:
    driver: local
  cortex_downloads:
    driver: local

networks:
  default:
    name: cortex_production